<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>GarageMarket — mobile-friendly</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#071125; --panel-grad:linear-gradient(180deg,#0e1a2b,#071827);
      --muted:#98a0b3; --accent:#d4a017; --accent-2:#0ea5a4; --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8;font-family:Montserrat,system-ui,Roboto,Arial}

    /* mobile-first layout */
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 84px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .badge{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#071827,#0b1a2b);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent)}
    h1{font-size:18px;margin:0}
    .sub{font-size:12px;color:var(--muted)}

    .search{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}
    .search input{flex:1;background:transparent;border:0;color:inherit;font-size:15px}

    .top-controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .tabs{display:flex;gap:8px;flex:1}
    .tab{flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.02);text-align:center;color:var(--muted);font-weight:600}
    .tab.active{background:linear-gradient(90deg, rgba(212,160,23,0.08), rgba(14,165,164,0.04));color:var(--accent)}
    .settings-btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);font-weight:700}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:720px){ .grid{grid-template-columns:repeat(3,1fr)} .wrap{padding:20px 28px 120px} }

    /* card simplified — animations removed */
    .card{background:var(--panel-grad);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:10px}
    .card .img{height:150px;border-radius:8px;overflow:hidden;background:#081522}
    .card .img img{width:100%;height:100%;object-fit:cover}

    .card .row{display:flex;justify-content:space-between;align-items:center}
    .name{font-weight:700;font-size:15px}
    .price{color:var(--accent);font-weight:800}
    .tags{display:flex;gap:8px;align-items:center}
    .sw{width:18px;height:18px;border-radius:4px;border:1px solid rgba(255,255,255,0.04)}
    .open{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:var(--muted);font-weight:700}
    .delete{background:transparent;border:1px solid rgba(255,0,0,0.18);padding:8px 10px;border-radius:8px;color:#ff7b7b;font-weight:800}

    .empty{padding:28px;text-align:center;color:var(--muted);border:1px dashed rgba(255,255,255,0.03);border-radius:12px}

    /* floating action — no animation */
    .fab{position:fixed;right:16px;bottom:18px;background:var(--accent);color:#071125;border:none;padding:14px 16px;border-radius:14px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,0.5);z-index:60}

    /* sheet modal (create/edit) */
    .sheet-back{position:fixed;inset:0;display:none;z-index:80}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,#081522,#06101a);border-top-left-radius:18px;border-top-right-radius:18px;padding:14px 14px 28px;height:88vh;overflow:auto;border:1px solid rgba(255,255,255,0.03);}

    .sheet .handle{width:64px;height:6px;background:rgba(255,255,255,0.04);border-radius:10px;margin:6px auto}
    label{display:block;font-size:13px;color:var(--muted);margin-top:12px}
    input[type=text],input[type=number],textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;margin-top:6px}
    textarea{min-height:110px}

    .img-row{display:flex;gap:10px;align-items:center;margin-top:10px}
    .img-preview{width:120px;height:120px;border-radius:10px;background:#06121a;border:1px dashed rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .img-preview img{width:100%;height:100%;object-fit:cover}

    .file-actions{display:flex;flex-direction:column;gap:8px}
    .file-actions input[type=file]{display:none}
    .small-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted)}

    .swatches{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .swatch{width:36px;height:36px;border-radius:8px;border:2px solid rgba(255,255,255,0.03);cursor:pointer}

    .controls{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    .btn{background:var(--accent);color:#071125;padding:12px 16px;border-radius:12px;border:0;font-weight:800}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}

    /* detail modal (centered for larger screens) */
    .detail-back{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:90}
    .detail{background:linear-gradient(180deg,#081522,#06101a);padding:14px;border-radius:12px;width:94%;max-width:900px;display:flex;gap:12px;border:1px solid rgba(255,255,255,0.03)}
    .detail .left{flex:1}
    .detail .left img{width:100%;height:360px;object-fit:cover;border-radius:8px}
    .detail .right{width:320px}

    /* sheet preview card */
    .sheet-preview{margin-top:12px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01)}

    @media(min-width:720px){ .sheet{height:80vh;border-radius:14px;padding:20px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="badge">GM</div>
      <div>
        <h1>GarageMarket</h1>
        <div class="sub">Proste, solidne, dla Ciebie i taty</div>
      </div>
    </header>

    <div class="search"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path stroke="currentColor" stroke-width="1.4" d="M21 21l-4.35-4.35"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.4"/></svg><input id="search" placeholder="Szukaj: nazwa, typ, kod, słowo..." /></div>

    <div class="top-controls">
      <div class="tabs"><button class="tab active" data-tab="all">Wszystkie</button><button class="tab" data-tab="classic">Klasyka</button><button class="tab" data-tab="modern">Nowoczesność</button></div>
      <button id="settingsBtn" class="settings-btn">Ustawienia</button>
    </div>

    <div id="grid" class="grid"></div>
    <div id="emptyState" class="empty" style="display:none">Brak ofert — dodaj pierwszą!</div>
  </div>

  <button id="fab" class="fab">+ Nowa oferta</button>

  <!-- sheet modal (create/edit) -->
  <div id="sheetBack" class="sheet-back">
    <div id="sheet" class="sheet" role="dialog">
      <div class="handle"></div>
      <h3 id="sheetTitle">Nowa oferta</h3>
      <label>Nazwa samochodu</label><input id="f_name" type="text" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1"><label>Cena (PLN)</label><input id="f_price" type="number" step="0.01" min="0" /></div>
        <div style="width:110px"><label>Rabat</label><select id="f_discount"><option>10</option><option>20</option><option>30</option></select></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1"><label>Rodzaj</label><select id="f_type"><option value="zwykly">zwykly</option><option value="sluzba">sluzba</option><option value="autobus">autobus</option></select></div>
        <div style="width:140px"><label>Kategoria</label><select id="f_cat"><option value="classic">Klasyka</option><option value="modern">Nowoczesność</option></select></div>
      </div>

      <label>Krótki opis</label><textarea id="f_desc"></textarea>

      <label>Wyszukiwane słowa-klucze (oddziel przecinkami)</label>
      <input id="f_keywords" type="text" placeholder="np. suv, terenowy, 4x4" />

      <label>Zdjęcie (kwadrat) — możesz użyć aparatu lub wybrać z biblioteki</label>
      <div class="img-row">
        <div class="img-preview" id="imgPreview">120×120</div>
        <div class="file-actions">
          <input id="f_img_capture" type="file" accept="image/*" capture="environment" />
          <input id="f_img_library" type="file" accept="image/*" />
          <div style="display:flex;flex-direction:column;gap:6px">
            <button id="btnCamera" class="small-btn">Zrób zdjęcie (aparat)</button>
            <button id="btnLibrary" class="small-btn">Wybierz z biblioteki</button>
            <button id="btnRemoveImg" class="small-btn">Usuń zdjęcie</button>
          </div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px">Plik będzie przycięty do kwadratu i skompresowany.</div>
        </div>
      </div>

      <label>Wybierz kolor samochodu</label>
      <div class="swatches" id="swatches"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input id="f_color" type="color" value="#0B69FF" style="width:54px;height:42px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)" />
        <button id="eyeDropperBtn" class="small-btn">Zakraplacz</button>
        <div style="font-size:12px;color:var(--muted);margin-left:6px">Kliknij próbkę lub użyj zakraplacza.</div>
      </div>

      <!-- live preview for the sheet -->
      <div id="sheetPreview" class="sheet-preview"></div>

      <div class="controls"><button id="sheetCancel" class="btn ghost">Anuluj</button><button id="sheetSave" class="btn">Zapisz ofertę</button></div>
    </div>
  </div>

  <!-- detail -->
  <div id="detailBack" class="detail-back"><div id="detailBox" class="detail"><div class="left"><img id="detailImg" src="" alt=""></div><div class="right"><h3 id="detailName">Nazwa</h3><div id="detailCode" style="color:var(--muted)"></div><div style="display:flex;align-items:center;margin-top:8px"><div id="detailPrice" class="price"></div><div id="detailOld" class="old" style="margin-left:8px;color:var(--muted)"></div></div><div id="detailDesc" style="margin-top:12px"></div><div style="margin-top:12px;display:flex;gap:8px;align-items:center"><div id="detailColor" style="width:20px;height:20px;border-radius:4px;border:1px solid rgba(255,255,255,0.05)"></div><div style="color:var(--muted)">Kolor samochodu</div></div><div id="buyArea" style="margin-top:14px"></div><div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px"><button id="detailDelete" class="delete">Usuń ofertę</button><button id="detailClose" class="small-btn">Zamknij</button></div></div></div></div>

<script>
/* GarageMarket - zmiany: dodane usuwanie ofert, słowa-klucze wyszukiwania, podgląd w formularzu, usunięte animacje */
const LS_OFFERS='gm_offers_v1';
const LS_LASTID='gm_lastid_v1';
let offers = loadOffers();
let stagedImgData = null;
let activeTab='all';

function loadOffers(){try{return JSON.parse(localStorage.getItem(LS_OFFERS)||'[]')||[]}catch(e){return []}}
function saveOffers(){localStorage.setItem(LS_OFFERS,JSON.stringify(offers));}
function getNextId(){let id=Number(localStorage.getItem(LS_LASTID)||'0')+1; localStorage.setItem(LS_LASTID,String(id)); return id}
function round2(n){return Math.round(n*100)/100}
function formatPrice(n){return Number(n).toFixed(2)+' PLN'}

// render grid
const grid = document.getElementById('grid'); const emptyState = document.getElementById('emptyState');
function render(){ const qRaw = document.getElementById('search').value.trim().toLowerCase(); const q = qRaw;
  let list = offers.filter(o=>!o.sold);
  if(activeTab==='classic') list = list.filter(o=>o.cat==='classic'); if(activeTab==='modern') list = list.filter(o=>o.cat==='modern');
  if(q){ list = list.filter(o=> (o.name||'').toLowerCase().includes(q) || (o.type||'').toLowerCase().includes(q) || (o.code||'').toLowerCase().includes(q) || (o.keywords||[]).some(k=>k.includes(q)) ); }
  grid.innerHTML=''; if(list.length===0){ emptyState.style.display='block'; } else { emptyState.style.display='none'; for(const o of list){ grid.appendChild(cardFromOffer(o)); } }
}

function cardFromOffer(o){ const el=document.createElement('div'); el.className='card'; el.dataset.id=o.id; const imgWrap=document.createElement('div'); imgWrap.className='img'; const img=document.createElement('img'); img.src=o.img||placeholderDataURL(o.type); imgWrap.appendChild(img); el.appendChild(imgWrap);
  const r1=document.createElement('div'); r1.className='row'; const name=document.createElement('div'); name.className='name'; name.textContent=o.name||'--';
  const price=document.createElement('div'); price.className='price'; price.textContent=formatPrice(o.price); r1.appendChild(name); r1.appendChild(price); el.appendChild(r1);
  const tags=document.createElement('div'); tags.className='tags'; const pill=document.createElement('div'); pill.className='pill'; pill.textContent=o.type||''; pill.style.padding='6px'; pill.style.background='rgba(255,255,255,0.02)'; pill.style.borderRadius='8px'; pill.style.fontSize='12px'; pill.style.color='var(--muted)'; const sw=document.createElement('div'); sw.className='sw'; sw.style.background=o.color||'#fff'; tags.appendChild(pill); tags.appendChild(sw); el.appendChild(tags);

  const row2=document.createElement('div'); row2.style.display='flex'; row2.style.justifyContent='space-between'; row2.style.alignItems='center'; row2.style.gap='8px'; row2.style.marginTop='8px';
  const openBtn=document.createElement('button'); openBtn.className='open'; openBtn.textContent='Otwórz'; openBtn.addEventListener('click',()=>openDetail(o.id));
  const delBtn=document.createElement('button'); delBtn.className='delete'; delBtn.textContent='Usuń'; delBtn.addEventListener('click',(e)=>{ e.stopPropagation(); if(confirm('Na pewno usunąć ofertę «'+o.name+'»?')) deleteOffer(o.id); });
  row2.appendChild(openBtn); row2.appendChild(delBtn); el.appendChild(row2);
  return el }

function placeholderDataURL(type){ const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%' height='100%' fill='#071827'/><text x='50%' y='50%' fill='#98a0b3' font-family='Montserrat' font-size='40' dominant-baseline='middle' text-anchor='middle'>${type||'brak zdjęcia'}</text></svg>`; return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg); }

// UI bindings
const fab = document.getElementById('fab'); const sheetBack = document.getElementById('sheetBack'); const sheet = document.getElementById('sheet'); const sheetSave = document.getElementById('sheetSave'); const sheetCancel = document.getElementById('sheetCancel'); const settingsBtn = document.getElementById('settingsBtn');
fab.addEventListener('click',openSheet); sheetCancel.addEventListener('click',closeSheet); sheetSave.addEventListener('click',saveOffer);
document.getElementById('search').addEventListener('input',render);
Array.from(document.querySelectorAll('.tab')).forEach(t=>t.addEventListener('click',e=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); e.currentTarget.classList.add('active'); activeTab=e.currentTarget.dataset.tab; render(); }))

// settings — animations removed, inform user
settingsBtn.addEventListener('click',()=>{ alert('Animacje zostały usunięte — brak opcji mega animacji.'); });

// swatches
const PRESET_COLORS=['#0B69FF','#0ea5a4','#d4a017','#111827','#e11d48','#06b6d4','#f97316','#94a3b8'];
const swatchesEl = document.getElementById('swatches'); const colorInput = document.getElementById('f_color');
function buildSwatches(){ swatchesEl.innerHTML=''; PRESET_COLORS.forEach(c=>{ const b=document.createElement('div'); b.className='swatch'; b.style.background=c; b.addEventListener('click',()=>{ colorInput.value = c; updatePreview(); }); swatchesEl.appendChild(b); }); }
buildSwatches();

// image handling
const fileCapture = document.getElementById('f_img_capture');
const fileLibrary = document.getElementById('f_img_library');
const btnCamera = document.getElementById('btnCamera');
const btnLibrary = document.getElementById('btnLibrary');
const btnRemoveImg = document.getElementById('btnRemoveImg');
const imgPreview = document.getElementById('imgPreview');
btnCamera.addEventListener('click',()=>fileCapture.click()); btnLibrary.addEventListener('click',()=>fileLibrary.click());

[fileCapture,fileLibrary].forEach(input => input.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  try{ stagedImgData = await fileToSquareDataURL(f,800); showPreview(stagedImgData); updatePreview(); }catch(err){ console.error(err); alert('Błąd przetwarzania zdjęcia'); }
}));

btnRemoveImg.addEventListener('click',()=>{ stagedImgData=null; fileCapture.value=''; fileLibrary.value=''; imgPreview.innerHTML='120×120'; updatePreview(); });

function showPreview(dataUrl){ imgPreview.innerHTML=''; const im=document.createElement('img'); im.src=dataUrl; imgPreview.appendChild(im); }

async function fileToSquareDataURL(file,size=800){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = async ()=>{
      try{
        let blob = new Blob([reader.result]);
        if(reader.result instanceof ArrayBuffer){ blob = new Blob([reader.result]); }
        let bitmap = null;
        if(window.createImageBitmap){ bitmap = await createImageBitmap(blob); }
        else { const tmp = new Image(); tmp.src = URL.createObjectURL(blob); await tmp.decode(); const cvs=document.createElement('canvas'); cvs.width=tmp.width; cvs.height=tmp.height; const ctx=cvs.getContext('2d'); ctx.drawImage(tmp,0,0); bitmap = await createImageBitmap(cvs); }
        const w = bitmap.width, h = bitmap.height; const s = Math.min(w,h); const sx = Math.floor((w - s)/2); const sy = Math.floor((h - s)/2);
        const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size; const ctx = canvas.getContext('2d'); ctx.fillStyle='#06121a'; ctx.fillRect(0,0,size,size);
        ctx.drawImage(bitmap, sx, sy, s, s, 0, 0, size, size);
        const data = canvas.toDataURL('image/jpeg',0.88);
        resolve(data);
      }catch(err){
        try{ const fr2 = new FileReader(); fr2.onload = ()=>{ const img = new Image(); img.onload = ()=>{ const w=img.width,h=img.height; const s=Math.min(w,h); const sx=Math.floor((w-s)/2); const sy=Math.floor((h-s)/2); const canvas=document.createElement('canvas'); canvas.width=size; canvas.height=size; const ctx=canvas.getContext('2d'); ctx.fillStyle='#06121a'; ctx.fillRect(0,0,size,size); ctx.drawImage(img,sx,sy,s,s,0,0,size,size); resolve(canvas.toDataURL('image/jpeg',0.88)); }; img.onerror=()=>reject(new Error('img load err')); img.src = fr2.result; }; fr2.onerror=()=>reject(new Error('fr2 err')); fr2.readAsDataURL(file);
        }catch(e){ reject(e); }
      }
    };
    reader.onerror = ()=>reject(new Error('file read err'));
    reader.readAsArrayBuffer(file);
  });
}

// eyedropper
const eyeDropperBtn = document.getElementById('eyeDropperBtn'); eyeDropperBtn.addEventListener('click', async ()=>{ if(!('EyeDropper' in window)){ alert('Zakraplacz nie jest wspierany w tej przeglądarce.'); return } try{ const eye = new EyeDropper(); const pick = await eye.open(); if(pick && pick.sRGBHex) colorInput.value = pick.sRGBHex; updatePreview(); }catch(e){ /* canceled */ } });

// save offer
const nameInput = document.getElementById('f_name'); const priceInput = document.getElementById('f_price'); const typeInput = document.getElementById('f_type'); const discountInput = document.getElementById('f_discount'); const catInput = document.getElementById('f_cat'); const descInput = document.getElementById('f_desc'); const keywordsInput = document.getElementById('f_keywords');
async function saveOffer(){ const name = nameInput.value.trim(); const price = parseFloat(priceInput.value); if(!name){ alert('Nazwa nie może być pusta'); return } if(isNaN(price) || price<0){ alert('Cena musi być poprawną liczbą >=0'); return } const type = typeInput.value; const discount = Number(discountInput.value); const cat = catInput.value==='classic'?'classic':'modern'; const desc = descInput.value.trim(); const color = colorInput.value || PRESET_COLORS[0]; const img = stagedImgData || null; const id = getNextId(); const code = String(id).padStart(4,'0'); const keywords = (keywordsInput.value||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  const item = { id, code, name, price: round2(price), type, discount, desc, img, cat, color, created: Date.now(), sold:false, keywords };
  offers.push(item); saveOffers(); closeSheet(); render(); alert('Zapisano ofertę: '+code); }

// sheet open/close
function openSheet(){ document.getElementById('sheetTitle').textContent='Nowa oferta'; stagedImgData=null; fileCapture.value=''; fileLibrary.value=''; imgPreview.innerHTML='120×120'; colorInput.value=PRESET_COLORS[0]; nameInput.value=''; priceInput.value=''; descInput.value=''; typeInput.value='zwykly'; discountInput.value='10'; catInput.value='classic'; keywordsInput.value=''; sheetBack.style.display='block'; setTimeout(()=>sheet.classList.add('show'),20); window.scrollTo({top:0}); updatePreview(); }
function closeSheet(){ sheet.classList.remove('show'); setTimeout(()=>sheetBack.style.display='none',350); }

// detail modal
const detailBack=document.getElementById('detailBack'); const detailBox=document.getElementById('detailBox'); const detailImg=document.getElementById('detailImg'); const detailName=document.getElementById('detailName'); const detailCode=document.getElementById('detailCode'); const detailPrice=document.getElementById('detailPrice'); const detailDesc=document.getElementById('detailDesc'); const detailColor=document.getElementById('detailColor'); const buyArea=document.getElementById('buyArea'); const detailDeleteBtn=document.getElementById('detailDelete'); document.getElementById('detailClose').addEventListener('click',()=>{ detailBack.style.display='none'; detailBox.classList.remove('show'); });

detailDeleteBtn.addEventListener('click',()=>{ const id = detailBox.dataset.offerId; if(!id) return; const o = offers.find(x=>x.id===Number(id)); if(!o) return; if(confirm('Na pewno usunąć ofertę «'+o.name+'»?')){ deleteOffer(o.id); detailBack.style.display='none'; detailBox.classList.remove('show'); } });

function openDetail(id){ const o = offers.find(x=>x.id===id); if(!o) return alert('Nie znaleziono oferty'); detailImg.src = o.img || placeholderDataURL(o.type); detailName.textContent = o.name; detailCode.textContent = 'kod: '+o.code; detailPrice.textContent = formatPrice(o.price); detailDesc.textContent = o.desc || ''; detailColor.style.background = o.color || '#ffffff'; buyArea.innerHTML=''; detailBox.dataset.offerId = o.id;
  if(o.sold){ buyArea.textContent='Sprzedane'; } else { const priceLabel=document.createElement('div'); priceLabel.textContent='Potwierdź lub zmień cenę:'; const priceInput = document.createElement('input'); priceInput.type='number'; priceInput.step='0.01'; priceInput.value = Number(o.price).toFixed(2); priceInput.style.width='100%'; priceInput.style.marginTop='8px'; const genBtn = document.createElement('button'); genBtn.className='btn'; genBtn.textContent='Generuj kod i kup'; genBtn.style.marginTop='10px'; buyArea.appendChild(priceLabel); buyArea.appendChild(priceInput); buyArea.appendChild(genBtn);
    genBtn.addEventListener('click', ()=>{ const finalPrice = parseFloat(priceInput.value); if(isNaN(finalPrice) || finalPrice<0){ alert('Cena musi być poprawną liczbą >=0'); return } const code = generateBuyCode(6); buyArea.innerHTML=''; const codeBox=document.createElement('div'); codeBox.textContent='Kod zakupowy: '+code; codeBox.style.marginTop='8px'; codeBox.style.padding='8px'; codeBox.style.background='rgba(255,255,255,0.02)'; const verify=document.createElement('input'); verify.type='text'; verify.placeholder='Wpisz kod'; verify.style.width='100%'; verify.style.marginTop='8px'; const confirmBtn=document.createElement('button'); confirmBtn.className='btn'; confirmBtn.textContent='Potwierdź kod i kup za '+formatPrice(finalPrice); confirmBtn.style.marginTop='8px'; buyArea.appendChild(codeBox); buyArea.appendChild(verify); buyArea.appendChild(confirmBtn);
      confirmBtn.addEventListener('click', ()=>{ if(verify.value.trim().toUpperCase() !== code){ alert('Kod niepoprawny'); return } buyArea.innerHTML='Kupione! Dzięki :)'; setTimeout(()=>{ finishBuy(o, finalPrice); },600); }); }); }
  detailBack.style.display='flex'; setTimeout(()=>detailBox.classList.add('show'),20); }

function finishBuy(item, paidPrice){ const idx = offers.findIndex(x=>x.id===item.id); if(idx>=0){ offers[idx].sold=true; offers[idx].paidPrice = round2(paidPrice); saveOffers(); render(); } }

function generateBuyCode(len=6){ const chars='ABCDEFGHJKMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }

// delete
function deleteOffer(id){ offers = offers.filter(x=>x.id!==id); saveOffers(); render(); }

// live preview in sheet
const sheetPreview = document.getElementById('sheetPreview');
function updatePreview(){ const name = nameInput.value.trim() || 'Nazwa'; const price = (priceInput.value ? formatPrice(priceInput.value) : '0.00 PLN'); const type = typeInput.value || 'typ'; const color = colorInput.value || PRESET_COLORS[0]; const img = stagedImgData || placeholderDataURL(type);
  sheetPreview.innerHTML = '';
  const card = document.createElement('div'); card.className='card'; card.style.padding='8px'; card.style.display='flex'; card.style.flexDirection='column';
  const imgWrap=document.createElement('div'); imgWrap.className='img'; imgWrap.style.height='120px'; const im=document.createElement('img'); im.src = img; imgWrap.appendChild(im); card.appendChild(imgWrap);
  const r1=document.createElement('div'); r1.className='row'; const nm=document.createElement('div'); nm.className='name'; nm.textContent=name; const pr=document.createElement('div'); pr.className='price'; pr.textContent=price; r1.appendChild(nm); r1.appendChild(pr); card.appendChild(r1);
  const tags=document.createElement('div'); tags.className='tags'; const pill=document.createElement('div'); pill.className='pill'; pill.textContent=type; pill.style.padding='6px'; pill.style.background='rgba(255,255,255,0.02)'; pill.style.borderRadius='8px'; pill.style.fontSize='12px'; pill.style.color='var(--muted)'; const sw=document.createElement('div'); sw.className='sw'; sw.style.background=color; tags.appendChild(pill); tags.appendChild(sw); card.appendChild(tags);
  sheetPreview.appendChild(card);
}

// update preview on inputs
[nameInput,priceInput,typeInput,descInput,keywordsInput,colorInput].forEach(el=>el.addEventListener('input',updatePreview));

// init preview also when image changes

// init
render(); updatePreview(); window._gm={offers,saveOffers,getNextId};
</script>
</body>
</html>
